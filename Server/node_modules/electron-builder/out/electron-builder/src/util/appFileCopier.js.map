{"version":3,"file":"appFileCopier.js","sourceRoot":"","sources":["../../../../src/util/appFileCopier.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { CONCURRENCY, FileCopier, Link, MAX_FILE_REQUESTS } from \"electron-builder-util/out/fs\"\nimport { ensureDir, readlink, symlink } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { AppFileCopierHelper, AppFileWalker } from \"./AppFileWalker\"\nimport { copyFileOrData } from \"./asarUtil\"\nimport { AsyncTaskManager } from \"./asyncTaskManager\"\n\nexport async function copyAppFiles(fileWalker: AppFileWalker, fileCopierHelper: AppFileCopierHelper, unpackedDest: string) {\n  const files: Array<string> = await fileCopierHelper.collect(fileWalker)\n  const metadata = fileWalker.metadata\n  const transformedFiles = fileCopierHelper.transformedFiles\n  // search auto unpacked dir\n  const unpackedDirs = new Set<string>()\n  const taskManager = new AsyncTaskManager(fileWalker.packager.cancellationToken)\n  const dirToCreateForUnpackedFiles = new Set<string>(unpackedDirs)\n\n  const fileCopier = new FileCopier()\n  const links: Array<Link> = []\n  for (let i = 0, n = files.length; i < n; i++) {\n    const file = files[i]\n    const stat = metadata.get(file)\n    if (stat == null) {\n      // dir\n      continue\n    }\n\n    const relativePath = file.replace(fileWalker.src, unpackedDest)\n    if (stat.isFile()) {\n      const fileParent = path.dirname(file)\n      // const dirNode = this.fs.getOrCreateNode(this.getRelativePath(fileParent))\n\n      const newData = transformedFiles == null ? null : <string | Buffer>transformedFiles[i]\n      if (newData != null) {\n        transformedFiles[i] = null\n      }\n\n      if (!dirToCreateForUnpackedFiles.has(fileParent)) {\n        dirToCreateForUnpackedFiles.add(fileParent)\n        await ensureDir(fileParent.replace(fileWalker.src, unpackedDest))\n      }\n\n      taskManager.addTask(copyFileOrData(fileCopier, newData, file, relativePath, stat))\n      if (taskManager.tasks.length > MAX_FILE_REQUESTS) {\n        await taskManager.awaitTasks()\n      }\n    }\n    else if (stat.isSymbolicLink()) {\n      links.push({\"file\": relativePath, \"link\": await readlink(file)})\n    }\n  }\n\n  if (taskManager.tasks.length > MAX_FILE_REQUESTS) {\n    await taskManager.awaitTasks()\n  }\n  if (links.length > 0) {\n    BluebirdPromise.map(links, it => symlink(it.link, it.file), CONCURRENCY)\n  }\n}"]}
